<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>安卓麦克风与语音识别测试</title>
    <style>
        /* 全局样式 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* 容器样式 */
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        /* 按钮样式 */
        button {
            background-color: #4CAF50; /* 绿色 */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        button:active {
            background-color: #3e8e41;
            transform: translateY(0);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* 状态和结果显示区域 */
        .status-section, .results-section {
            margin-top: 25px;
            padding: 20px;
            background-color: #e8f5e9; /* 淡绿色背景 */
            border-radius: 10px;
            border: 1px solid #d4edda;
            text-align: left;
        }

        .status-section h2, .results-section h2 {
            color: #2e7d32;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        #status-message {
            font-size: 1.1em;
            color: #333;
            line-height: 1.6;
        }

        #recognition-results {
            white-space: pre-wrap; /* 保留空白符和换行符 */
            word-break: break-word; /* 允许单词在长文本中换行 */
            min-height: 80px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            font-size: 1.1em;
            color: #555;
            overflow-y: auto; /* 允许内容过多时滚动 */
            max-height: 200px;
        }

        .error {
            color: #d32f2f; /* 红色 */
            font-weight: bold;
        }

        .success {
            color: #388e3c; /* 绿色 */
            font-weight: bold;
        }

        /* 小屏幕适配 */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            button {
                width: 100%;
                margin: 8px 0;
            }
            h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>安卓麦克风与语音识别测试</h1>
        <p>点击下方按钮，测试您的安卓设备浏览器是否支持麦克风权限和语音识别功能。</p>

        <div class="controls">
            <button id="requestPermissionButton">请求麦克风权限</button>
            <button id="startRecognitionButton" disabled>开始语音识别</button>
            <button id="stopRecognitionButton" disabled>停止语音识别</button>
        </div>

        <div class="status-section">
            <h2>当前状态</h2>
            <p id="status-message">等待操作...</p>
        </div>
    </div>

    <div class="container results-section">
        <h2>识别结果</h2>
        <pre id="recognition-results">暂无识别结果。</pre>
    </div>

    <script>
        // 核心功能模块
        const SpeechRecognitionModule = (function() {
            // 私有变量
            let recognition = null;
            let isRecognizing = false;
            let finalTranscript = '';

            // 获取DOM元素
            const statusMessageElement = document.getElementById('status-message');
            const recognitionResultsElement = document.getElementById('recognition-results');
            const startRecognitionButton = document.getElementById('startRecognitionButton');
            const stopRecognitionButton = document.getElementById('stopRecognitionButton');
            const requestPermissionButton = document.getElementById('requestPermissionButton');

            /**
             * @module Permissions
             * @description 处理麦克风权限请求和检查
             */
            const Permissions = (function() {
                /**
                 * 请求麦克风权限
                 * @returns {Promise<boolean>} 如果成功获取权限返回 true，否则返回 false
                 */
                async function requestMicrophonePermission() {
                    statusMessageElement.textContent = '正在请求麦克风权限...';
                    try {
                        // 使用 navigator.mediaDevices.getUserMedia 请求麦克风权限
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        // 权限获取成功后，停止流以释放麦克风
                        stream.getTracks().forEach(track => track.stop());
                        statusMessageElement.textContent = '麦克风权限已授予。您可以开始语音识别了。';
                        statusMessageElement.className = 'success'; // 添加成功样式
                        startRecognitionButton.disabled = false; // 启用开始识别按钮
                        return true;
                    } catch (error) {
                        console.error('获取麦克风权限失败:', error);
                        let errorMessage = '获取麦克风权限失败。请检查您的设备设置，确保浏览器有权访问麦克风。';
                        if (error.name === 'NotAllowedError') {
                            errorMessage = '用户拒绝了麦克风权限请求或权限已被禁用。';
                        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                            errorMessage = '未找到麦克风设备。';
                        }
                        statusMessageElement.textContent = errorMessage;
                        statusMessageElement.className = 'error'; // 添加错误样式
                        startRecognitionButton.disabled = true; // 禁用开始识别按钮
                        return false;
                    }
                }

                return {
                    requestMicrophonePermission
                };
            })();

            /**
             * @module SpeechRecognition
             * @description 处理语音识别的核心逻辑
             */
            const SpeechRecognition = (function() {
                /**
                 * 初始化语音识别对象
                 */
                function initializeRecognition() {
                    // 检查浏览器是否支持 Web Speech API
                    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                        statusMessageElement.textContent = '抱歉，您的浏览器不支持语音识别功能。请尝试使用支持Web Speech API的最新版Chrome浏览器。';
                        statusMessageElement.className = 'error';
                        startRecognitionButton.disabled = true;
                        stopRecognitionButton.disabled = true;
                        return;
                    }

                    // 优先使用webkitSpeechRecognition（Chrome等）
                    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

                    // 设置语音识别的属性
                    recognition.continuous = true; // 持续识别，直到调用 stop()
                    recognition.interimResults = true; // 返回临时结果，可以实时显示用户正在说什么
                    recognition.lang = 'zh-CN'; // 设置识别语言为中文（中国）

                    // 事件监听器
                    recognition.onstart = function() {
                        isRecognizing = true;
                        statusMessageElement.textContent = '语音识别已启动，请开始讲话...';
                        statusMessageElement.className = ''; // 清除样式
                        startRecognitionButton.disabled = true;
                        stopRecognitionButton.disabled = false;
                        finalTranscript = ''; // 重置最终识别结果
                        recognitionResultsElement.textContent = '正在倾听...';
                    };

                    recognition.onresult = function(event) {
                        let interimTranscript = '';
                        // 遍历所有识别结果
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript; // 最终结果累加
                            } else {
                                interimTranscript += transcript; // 临时结果
                            }
                        }
                        // 显示临时和最终结果
                        recognitionResultsElement.textContent = `最终结果: ${finalTranscript}\n临时结果: ${interimTranscript}`;
                    };

                    recognition.onerror = function(event) {
                        isRecognizing = false;
                        console.error('语音识别错误:', event.error);
                        let errorMessage = `语音识别错误：${event.error}`;
                        if (event.error === 'not-allowed') {
                            errorMessage = '语音识别被拒绝。请确保已授权麦克风权限。';
                        } else if (event.error === 'no-speech') {
                            errorMessage = '未检测到语音。请确保麦克风正常工作并重新尝试。';
                        } else if (event.error === 'network') {
                            errorMessage = '网络错误，请检查您的网络连接。';
                        }
                        statusMessageElement.textContent = errorMessage;
                        statusMessageElement.className = 'error';
                        startRecognitionButton.disabled = false;
                        stopRecognitionButton.disabled = true;
                    };

                    recognition.onend = function() {
                        isRecognizing = false;
                        statusMessageElement.textContent = '语音识别已停止。';
                        statusMessageElement.className = '';
                        startRecognitionButton.disabled = false;
                        stopRecognitionButton.disabled = true;
                        // 如果有最终结果，确保显示
                        if (finalTranscript) {
                            recognitionResultsElement.textContent = `最终识别结果:\n${finalTranscript}`;
                        } else {
                            recognitionResultsElement.textContent = '暂无识别结果。';
                        }
                    };
                }

                /**
                 * 开始语音识别
                 */
                function startRecognition() {
                    if (!recognition) {
                        initializeRecognition(); // 如果尚未初始化，则初始化
                    }
                    if (recognition && !isRecognizing) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error('启动语音识别失败:', e);
                            statusMessageElement.textContent = '启动语音识别失败。可能已经启动或权限问题。';
                            statusMessageElement.className = 'error';
                        }
                    } else if (isRecognizing) {
                        statusMessageElement.textContent = '语音识别正在进行中...';
                    }
                }

                /**
                 * 停止语音识别
                 */
                function stopRecognition() {
                    if (recognition && isRecognizing) {
                        recognition.stop();
                    } else {
                        statusMessageElement.textContent = '语音识别未启动或已停止。';
                    }
                }

                return {
                    initializeRecognition,
                    startRecognition,
                    stopRecognition
                };
            })();

            /**
             * @module EventHandlers
             * @description 页面事件处理
             */
            const EventHandlers = (function() {
                /**
                 * 初始化所有事件监听器
                 */
                function init() {
                    requestPermissionButton.addEventListener('click', Permissions.requestMicrophonePermission);
                    startRecognitionButton.addEventListener('click', SpeechRecognition.startRecognition);
                    stopRecognitionButton.addEventListener('click', SpeechRecognition.stopRecognition);

                    // 页面加载完成时初始化语音识别对象
                    // 这可以在用户点击前预加载，但考虑到权限问题，更倾向于在用户点击“开始”后或在请求权限成功后初始化。
                    // 这里我们在开始识别前检查是否已初始化，确保流程清晰。
                }

                return {
                    init
                };
            })();

            // 公开接口，暴露给外部调用
            return {
                init: EventHandlers.init // 初始化所有事件处理器
            };

        })(); // 立即执行函数表达式 (IIFE)

        // 页面加载完成后调用初始化函数
        document.addEventListener('DOMContentLoaded', SpeechRecognitionModule.init);
    </script>
</body>
</html>