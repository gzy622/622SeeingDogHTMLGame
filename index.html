<<<<<<< SEARCH
        function setVideoSource(videoElement, src) {
            return new Promise((resolve) => {
                videoElement.classList.remove('loaded');
                videoElement.poster = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";

                const onLoadedData = () => {
                    videoElement.classList.add('loaded');
                    videoElement.poster = "";
                    videoElement.removeEventListener('loadeddata', onLoadedData);
                    videoElement.removeEventListener('canplay', onLoadedData);
                    resolve();
                };
                
                videoElement.addEventListener('loadeddata', onLoadedData);
                videoElement.addEventListener('canplay', onLoadedData);
                
                videoElement.src = src;
                videoElement.load();
            });
        }
=======
        class VideoController {
            constructor(videoElement) {
                this.video = videoElement;
                this._endCallback = null;
                this._eventListeners = new Map();
            }

            load(src) {
                return new Promise((resolve) => {
                    this._clearEventListeners();
                    this.video.classList.remove('loaded');
                    this.video.poster = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";

                    const onReady = () => {
                        this.video.classList.add('loaded');
                        this.video.poster = "";
                        this._removeLoadListeners();
                        resolve();
                    };

                    this._addEventListener('loadeddata', onReady);
                    this._addEventListener('canplay', onReady);
                    
                    this.video.src = src;
                    this.video.load().catch(e => {
                        console.error(`Video load failed: ${e.message}`);
                        showToast('视频加载失败，请检查网络连接');
                    });
                });
            }

            play() {
                this.video.play().catch(e => {
                    console.error(`Video play failed: ${e.message}`);
                    showToast('视频播放失败，请尝试重新开始游戏');
                });
            }

            pause() {
                this.video.pause();
            }

            setLoop(isLooping) {
                this.video.loop = isLooping;
            }

            onEnded(callback) {
                this._endCallback = callback;
                this._addEventListener('ended', () => {
                    callback?.();
                    this._endCallback = null;
                });
            }

            _addEventListener(type, handler) {
                this.video.addEventListener(type, handler);
                this._eventListeners.set(type, handler);
            }

            _removeLoadListeners() {
                ['loadeddata', 'canplay'].forEach(type => {
                    const handler = this._eventListeners.get(type);
                    if (handler) {
                        this.video.removeEventListener(type, handler);
                        this._eventListeners.delete(type);
                    }
                });
            }

            // 统一管理视频状态
            _updateVideoState(newState) {
                this.video.dataset.state = newState;
                this.video.classList.toggle('active', newState === 'playing');
            }

            // 处理视频错误
            _handleError(error) {
                console.error('Video error:', error);
                this.video.poster = RESOURCES.images.errorFallback;
                this._clearEventListeners();
                this._endCallback?.();
            }

            // 添加带自动清理的事件监听
            _addEventListener(type, handler) {
                const wrappedHandler = (...args) => {
                    if (this.video.readyState < 2) return;
                    handler(...args);
                };
                
                this.video.addEventListener(type, wrappedHandler);
                this._eventListeners.set(type, wrappedHandler);
            }

            // 安全播放方法
            async play() {
                try {
                    await this.video.play();
                    this._updateVideoState('playing');
                } catch (error) {
                    this._handleError(error);
                }
            }

            // 带状态管理的暂停
            pause() {
                this.video.pause();
                this._updateVideoState('paused');
            }

            // 安全停止并重置
            stop() {
                this.pause();
                this.video.currentTime = 0;
                this._updateVideoState('stopped');
                this._clearEventListeners();
            }

            _clearEventListeners() {
                this._eventListeners.forEach((handler, type) => {
                    this.video.removeEventListener(type, handler);
                });
                this._eventListeners.clear();
            }
        }

        const dogVideoController = new VideoController(dom.dogVideo);
        
        // 初始化视频错误处理
        dogVideoController._addEventListener('error', (e) => {
            dogVideoController._handleError(e);
        });
>>>>>>> REPLACE