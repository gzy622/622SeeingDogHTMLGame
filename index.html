<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¾åº¦æ™ºèƒ½äº‘è¯­éŸ³è¯†åˆ«</title>
    <!-- å¼•å…¥ Tailwind CSS CDNï¼Œç”¨äºç¾åŒ–ç•Œé¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è®¾ç½®å…¨å±€å­—ä½“ä¸º Interï¼Œç¡®ä¿ç¾è§‚ */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 flex items-center justify-center min-h-screen p-4;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg text-center border-b-4 border-blue-500">
        <h1 class="text-3xl font-extrabold mb-6 text-gray-800 tracking-tight">ğŸ™ï¸ ç™¾åº¦æ™ºèƒ½äº‘è¯­éŸ³è¯†åˆ«</h1>
        <p class="text-gray-600 mb-6 leading-relaxed">ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®å¼€å§‹å½•éŸ³ï¼Œå†æ¬¡ç‚¹å‡»åœæ­¢å½•éŸ³å¹¶å‘é€ç»™ç™¾åº¦æ™ºèƒ½äº‘è¯†åˆ«ã€‚</p>

        <!-- é‡è¦çš„ API Key å’Œ Secret Key é…ç½®æé†’ -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-6 text-left" role="alert">
            <p class="font-bold">é‡è¦æç¤ºï¼š</p>
            <p class="text-sm">è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„ç™¾åº¦æ™ºèƒ½äº‘ **API Key** å’Œ **Secret Key**ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯†é’¥ä¸åº”ç›´æ¥æš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­ï¼Œè¯·é€šè¿‡åç«¯æœåŠ¡è·å– Access Token å’Œè¿›è¡Œè¯­éŸ³è¯†åˆ«è¯·æ±‚ã€‚</p>
            <p class="text-sm mt-2">å¦‚ä½•è·å– API Key å’Œ Secret Keyï¼Œè¯·å‚è€ƒä¸‹æ–¹çš„è¯´æ˜ã€‚</p>
        </div>

        <!-- å¯†é’¥è¾“å…¥åŒºåŸŸ -->
        <div class="mb-6 space-y-4 text-left">
            <div>
                <label for="apiKeyInput" class="block text-gray-700 text-sm font-bold mb-2">
                    ç™¾åº¦ API Key:
                </label>
                <input type="text" id="apiKeyInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ API Key"
                       class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition duration-200">
            </div>
            <div>
                <label for="secretKeyInput" class="block text-gray-700 text-sm font-bold mb-2">
                    ç™¾åº¦ Secret Key:
                </label>
                <input type="text" id="secretKeyInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ Secret Key"
                       class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition duration-200">
            </div>
        </div>

        <button id="startStopBtn"
                class="px-8 py-4 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
            å¼€å§‹å½•éŸ³
        </button>

        <div class="mt-8">
            <p id="status" class="text-lg text-gray-700 font-medium mb-4">å‡†å¤‡å°±ç»ª...</p>
            <div id="result" class="bg-gray-50 p-6 rounded-lg border border-gray-200 text-gray-800 text-left min-h-[120px] max-h-60 overflow-y-auto leading-relaxed shadow-inner">
                <span class="text-gray-400">å½•éŸ³ç»“æŸåï¼Œè¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</span>
            </div>
        </div>

        <!-- æ¨¡æ€æ¡†ç”¨äºæ˜¾ç¤ºæç¤ºä¿¡æ¯ï¼Œæ›¿ä»£ alert() -->
        <div id="messageModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
                <h3 class="text-xl font-semibold mb-4 text-gray-800" id="modalTitle">æç¤º</h3>
                <p class="text-gray-700 mb-6" id="modalContent">è¿™æ˜¯ä¸€ä¸ªæç¤ºæ¶ˆæ¯ã€‚</p>
                <button id="closeModalBtn" class="px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-300">
                    ç¡®å®š
                </button>
            </div>
        </div>
    </div>

    <script>
        // è·å–é¡µé¢å…ƒç´ 
        const apiKeyInput = document.getElementById('apiKeyInput');
        const secretKeyInput = document.getElementById('secretKeyInput');
        const startStopBtn = document.getElementById('startStopBtn');
        const statusDisplay = document.getElementById('status');
        const resultDisplay = document.getElementById('result');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // ä» localStorage åŠ è½½ä¿å­˜çš„å¯†é’¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        window.onload = () => {
            const savedApiKey = localStorage.getItem('baidu_api_key');
            const savedSecretKey = localStorage.getItem('baidu_secret_key');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
            }
            if (savedSecretKey) {
                secretKeyInput.value = savedSecretKey;
            }
        };

        let mediaRecorder; // MediaRecorder å¯¹è±¡
        let audioChunks = []; // ç”¨äºå­˜å‚¨éŸ³é¢‘æ•°æ®å—
        let audioStream; // ç”¨äºå­˜å‚¨ MediaStream å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨åœæ­¢æ—¶å…³é—­éº¦å…‹é£è½¨é“
        let isRecording = false; // æ ‡è®°å½“å‰æ˜¯å¦æ­£åœ¨å½•éŸ³
        let baiduAccessToken = ''; // å­˜å‚¨ç™¾åº¦ Access Token

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(title, content) {
            modalTitle.textContent = title;
            modalContent.textContent = content;
            messageModal.classList.remove('hidden');
        }

        // å…³é—­æ¨¡æ€æ¡†
        closeModalBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // è·å–ç™¾åº¦ Access Token
        async function getBaiduAccessToken(BAIDU_API_KEY, BAIDU_SECRET_KEY) {
            if (!BAIDU_API_KEY || !BAIDU_SECRET_KEY) {
                showModal('é…ç½®é”™è¯¯', 'è¯·å¡«å†™æ‚¨çš„ç™¾åº¦ API Key å’Œ Secret Keyã€‚');
                return false;
            }

            const BAIDU_TOKEN_URL = `https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${BAIDU_API_KEY}&client_secret=${BAIDU_SECRET_KEY}`;

            try {
                statusDisplay.textContent = 'æ­£åœ¨è·å–è®¤è¯ä»¤ç‰Œ...';
                const response = await fetch(BAIDU_TOKEN_URL, { method: 'POST', mode: 'cors' });
                const data = await response.json();

                if (response.ok && data.access_token) {
                    baiduAccessToken = data.access_token;
                    statusDisplay.textContent = 'è®¤è¯æˆåŠŸï¼';
                    // æˆåŠŸè·å–tokenåï¼Œå°†å¯†é’¥ä¿å­˜åˆ° localStorage
                    localStorage.setItem('baidu_api_key', BAIDU_API_KEY);
                    localStorage.setItem('baidu_secret_key', BAIDU_SECRET_KEY);
                    return true;
                } else {
                    showModal('è®¤è¯å¤±è´¥', `è·å– Access Token å¤±è´¥: ${data.error_description || 'æœªçŸ¥é”™è¯¯'}`);
                    console.error('Failed to get Baidu Access Token:', data);
                    return false;
                }
            } catch (error) {
                showModal('ç½‘ç»œæˆ–è·¨åŸŸé”™è¯¯', `è·å– Access Token æ—¶ç½‘ç»œå‡ºé”™æˆ–è¢«æµè§ˆå™¨å®‰å…¨ç­–ç•¥é˜»æ­¢: ${error.message}ã€‚\n\nè¯·ç¡®ä¿æ‚¨çš„ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œå¹¶æ£€æŸ¥å½“å‰è¿è¡Œç¯å¢ƒæ˜¯å¦å…è®¸è·¨åŸŸè¯·æ±‚ï¼ˆä¾‹å¦‚ï¼Œç›´æ¥æ‰“å¼€æœ¬åœ°HTMLæ–‡ä»¶å¯èƒ½ä¼šé‡åˆ°æ­¤é—®é¢˜ï¼‰ã€‚`);
                console.error('Error fetching Baidu Access Token:', error);
                return false;
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            const BAIDU_API_KEY = apiKeyInput.value.trim();
            const BAIDU_SECRET_KEY = secretKeyInput.value.trim();

            if (!BAIDU_API_KEY || !BAIDU_SECRET_KEY) {
                showModal('å¯†é’¥ç¼ºå¤±', 'è¯·åœ¨å¼€å§‹å½•éŸ³å‰å¡«å†™æ‚¨çš„ç™¾åº¦ API Key å’Œ Secret Keyã€‚');
                return;
            }

            // åœ¨å¼€å§‹å½•éŸ³å‰å…ˆè·å– Access Token
            // æ¯æ¬¡å¯åŠ¨å½•éŸ³éƒ½å°è¯•è·å–æ–°çš„ Access Tokenï¼Œæˆ–è€…æ£€æŸ¥ç°æœ‰ Token æ˜¯å¦æœ‰æ•ˆ
            // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œæ¯æ¬¡éƒ½å°è¯•é‡æ–°è·å–ï¼Œæ›´ä¼˜è§£æ˜¯åˆ¤æ–­ Token æ˜¯å¦è¿‡æœŸ
            const tokenSuccess = await getBaiduAccessToken(BAIDU_API_KEY, BAIDU_SECRET_KEY);
            if (!tokenSuccess) {
                // å¦‚æœè·å– Access Token å¤±è´¥ï¼Œåˆ™ä¸ç»§ç»­å½•éŸ³
                statusDisplay.textContent = 'å‡†å¤‡å°±ç»ª...';
                return;
            }

            try {
                statusDisplay.textContent = 'è¯·æ±‚éº¦å…‹é£æƒé™...';
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 16000 // ç™¾åº¦è¯­éŸ³è¯†åˆ«æ¨èçš„é‡‡æ ·ç‡
                    }
                });

                // åˆ›å»º MediaRecorder å®ä¾‹
                // ç™¾åº¦è¯­éŸ³è¯†åˆ«æ”¯æŒ Opus ç¼–ç çš„ WebM æ ¼å¼
                mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm; codecs=opus' });
                audioChunks = []; // æ¸…ç©ºä¹‹å‰çš„éŸ³é¢‘æ•°æ®

                // å½“ MediaRecorder æœ‰å¯ç”¨æ•°æ®æ—¶è§¦å‘
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                // å½“ MediaRecorder åœæ­¢æ—¶è§¦å‘
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm; codecs=opus' });
                    sendAudioToBaidu(audioBlob); // å‘é€éŸ³é¢‘åˆ°ç™¾åº¦æ™ºèƒ½äº‘ API
                    // å…³é—­éº¦å…‹é£è½¨é“ï¼Œé‡Šæ”¾èµ„æº
                    audioStream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start(); // å¼€å§‹å½•éŸ³
                isRecording = true;
                statusDisplay.textContent = 'æ­£åœ¨å½•éŸ³... è¯·å¼€å§‹è¯´è¯...';
                startStopBtn.textContent = 'åœæ­¢å½•éŸ³å¹¶è¯†åˆ«';
                startStopBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                startStopBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                resultDisplay.innerHTML = '<span class="text-gray-400">å½•éŸ³ç»“æŸåï¼Œè¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</span>'; // æ¸…ç©ºç»“æœæ˜¾ç¤ºåŒºåŸŸ

            } catch (err) {
                // å¤„ç†è·å–éº¦å…‹é£æƒé™æˆ–å¯åŠ¨å½•éŸ³çš„é”™è¯¯
                isRecording = false;
                startStopBtn.textContent = 'å¼€å§‹å½•éŸ³';
                startStopBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                startStopBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                statusDisplay.textContent = 'å‡†å¤‡å°±ç»ª...';

                let errorMessage = '';
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·å…è®¸æœ¬ç½‘ç«™è®¿é—®éº¦å…‹é£ã€‚';
                } else if (err.name === 'NotFoundError') {
                    errorMessage = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ã€‚è¯·æ£€æŸ¥æ‚¨çš„è®¾å¤‡æ˜¯å¦æœ‰éº¦å…‹é£ã€‚';
                } else {
                    errorMessage = `æ— æ³•å¯åŠ¨å½•éŸ³: ${err.message || err.name}ã€‚è¯·æ£€æŸ¥æ‚¨çš„éº¦å…‹é£è®¾ç½®ã€‚`;
                }
                showModal('éº¦å…‹é£é”™è¯¯', errorMessage);
                console.error('Error starting recording:', err);
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isRecording = false;
                statusDisplay.textContent = 'å½•éŸ³åœæ­¢ï¼Œæ­£åœ¨å‘é€éŸ³é¢‘è¿›è¡Œè¯†åˆ«...';
            }
        }

        // å°†å½•åˆ¶çš„éŸ³é¢‘å‘é€åˆ° ç™¾åº¦æ™ºèƒ½äº‘è¯­éŸ³è¯†åˆ« API
        async function sendAudioToBaidu(audioBlob) {
            if (!baiduAccessToken) {
                showModal('é”™è¯¯', 'Access Token æœªè·å–æˆ–å·²å¤±æ•ˆï¼Œè¯·é‡æ–°å°è¯•ã€‚');
                statusDisplay.textContent = 'è¯†åˆ«å¤±è´¥ã€‚';
                resetButtonState();
                return;
            }

            // ä½¿ç”¨ FileReader å°† Blob è½¬æ¢ä¸º Base64 å­—ç¬¦ä¸²
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const base64Audio = reader.result.split(',')[1]; // ç§»é™¤æ•°æ® URL çš„å‰ç¼€

                // ç™¾åº¦ API çš„ CUID (Client User ID) å¯ä»¥æ˜¯éšæœºç”Ÿæˆçš„å”¯ä¸€å­—ç¬¦ä¸²
                const cuid = 'web_user_' + Date.now();

                // ç™¾åº¦è¯­éŸ³è¯†åˆ«çŸ­éŸ³é¢‘æ¥å£çš„å‚æ•°
                const payload = {
                    format: 'opus', // éŸ³é¢‘æ ¼å¼ï¼Œä¸ MediaRecorder çš„ mimeType å¯¹åº”
                    rate: 16000, // é‡‡æ ·ç‡ï¼Œä¸ getUserMedia ä¸­çš„è®¾ç½®ä¸€è‡´
                    channel: 1, // å£°é“æ•°ï¼Œé»˜è®¤ä¸ºå•å£°é“
                    cuid: cuid, // å®¢æˆ·ç«¯ç”¨æˆ· ID
                    token: baiduAccessToken, // è®¿é—®ä»¤ç‰Œ
                    dev_pid: 1537, // å¸¸ç”¨æ™®é€šè¯è¯†åˆ«æ¨¡å‹ID (1537 æˆ– 80001)
                    speech: base64Audio, // Base64 ç¼–ç çš„éŸ³é¢‘æ•°æ®
                    len: audioBlob.size, // éŸ³é¢‘é•¿åº¦ (å­—èŠ‚æ•°)
                };

                try {
                    resultDisplay.textContent = 'æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...';
                    const response = await fetch(BAIDU_ASR_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json();

                    if (response.ok && data.err_no === 0) { // err_no ä¸º 0 è¡¨ç¤ºæˆåŠŸ
                        if (data.result && data.result.length > 0) {
                            resultDisplay.textContent = data.result[0]; // ç™¾åº¦è¯†åˆ«ç»“æœé€šå¸¸åœ¨ result æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
                            statusDisplay.textContent = 'è¯†åˆ«æˆåŠŸï¼';
                        } else {
                            resultDisplay.textContent = 'æœªèƒ½è¯†åˆ«å‡ºä»»ä½•å†…å®¹ã€‚è¯·é‡æ–°å°è¯•ã€‚';
                            statusDisplay.textContent = 'è¯†åˆ«å®Œæˆã€‚';
                        }
                    } else {
                        // API è¿”å›é”™è¯¯ï¼ˆä¾‹å¦‚ï¼šToken æ— æ•ˆã€å‚æ•°é”™è¯¯ç­‰ï¼‰
                        statusDisplay.textContent = 'è¯†åˆ«å¤±è´¥ã€‚';
                        showModal('ç™¾åº¦ API é”™è¯¯', `è¯†åˆ«å¤±è´¥ï¼š${data.err_msg || 'æœªçŸ¥é”™è¯¯'}\né”™è¯¯ç : ${data.err_no || 'N/A'}`);
                        console.error('Baidu API Error:', data);
                        // å¦‚æœæ˜¯ Token é”™è¯¯ï¼Œå¯ä»¥å°è¯•æ¸…ç©º Token å¼ºåˆ¶é‡æ–°è·å–
                        if (data.err_no === 3302 || data.err_no === 3301) { // 3302: Tokenå¤±æ•ˆï¼Œ3301: Tokenæ— æ•ˆ
                            baiduAccessToken = '';
                        }
                    }
                } catch (error) {
                    // ç½‘ç»œè¯·æ±‚æœ¬èº«çš„é”™è¯¯ï¼ˆä¾‹å¦‚ï¼šæ–­ç½‘ï¼‰
                    statusDisplay.textContent = 'è¯†åˆ«å¤±è´¥ã€‚';
                    showModal('ç½‘ç»œè¯·æ±‚é”™è¯¯', `å‘é€è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚`);
                    console.error('Fetch error:', error);
                } finally {
                    resetButtonState();
                }
            };
        }

        // é‡ç½®æŒ‰é’®çŠ¶æ€
        function resetButtonState() {
            startStopBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            startStopBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            startStopBtn.textContent = 'å¼€å§‹å½•éŸ³';
        }

        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
        startStopBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });
    </script>
</body>
</html>
